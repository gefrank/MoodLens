{% extends "base.html" %}

{% block title %}Webcam Mood Analysis{% endblock %}

{% block content %}
<h1 class="text-center my-4">Webcam Mood Analysis</h1>
<div class="text-center">
    <div class="mb-3">
        <div class="btn-group" role="group" aria-label="Face Detection Backend">
            <input type="radio" class="btn-check" name="backend" id="retinaface" value="retinaface" checked>
            <label class="btn btn-outline-primary" for="retinaface">RetinaFace</label>

            <input type="radio" class="btn-check" name="backend" id="mtcnn" value="mtcnn">
            <label class="btn btn-outline-primary" for="mtcnn">MTCNN</label>

            <input type="radio" class="btn-check" name="backend" id="opencv" value="opencv">
            <label class="btn btn-outline-primary" for="opencv">OpenCV</label>

            <input type="radio" class="btn-check" name="backend" id="ssd" value="ssd">
            <label class="btn btn-outline-primary" for="ssd">SSD</label>
        </div>
    </div>
    
    <!-- Camera status indicator -->
    <div id="cameraStatus" class="alert alert-info mb-3" style="display: none;">
        Initializing camera...
    </div>

    <video id="video" autoplay class="mb-3 rounded shadow-sm"></video>
    <canvas id="canvas" style="display:none;"></canvas>
    
    <!-- Countdown overlay -->
    <div id="countdown" class="position-absolute top-50 start-50 translate-middle display-1" 
         style="display:none; z-index: 1000; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
    </div>

    <div class="d-flex align-items-start justify-content-center gap-3">
        <img id="capturedImage" class="img-fluid rounded shadow-sm" style="max-width: 40%; display: none;" alt="Captured Image">
        <div id="moodResultOverlay" class="text-center py-3 px-4 rounded shadow-sm" 
             style="background: rgba(0,0,0,0.9); color: white; display: none; min-width: 300px;">
            <div id="moodResultText" class="fs-4 mb-2"></div>
            <div id="confidenceScore" class="small mb-3"></div>
            <div id="allEmotions" class="small" style="font-size: 0.8rem;"></div>
        </div>
    </div>
    
    <div class="mb-3">
        <button id="capture" class="btn btn-primary mb-2">
            <span id="captureText">Capture Mood</span>
            <span id="loadingSpinner" class="spinner-border spinner-border-sm" style="display: none;" role="status">
                <span class="visually-hidden">Loading...</span>
            </span>
        </button>
        <button id="clear" class="btn btn-secondary mb-2" style="display: none;">Clear</button>
        <button id="timer" class="btn btn-info mb-2 ms-2">Use 3s Timer</button>
    </div>

    <!-- History section -->
    <div class="card mt-4" style="display: none;" id="historyCard">
        <div class="card-header">
            Recent Results
        </div>
        <div class="card-body">
            <div id="moodHistory" class="list-group">
                <!-- History items will be added here -->
            </div>
        </div>
    </div>

    <p id="moodResult" class="mt-3 text-center fs-4 text-primary"></p>
    <p id="errorMessage" class="mt-3 text-center fs-4 text-danger"></p>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureButton = document.getElementById('capture');
    const clearButton = document.getElementById('clear');
    const timerButton = document.getElementById('timer');
    const moodResult = document.getElementById('moodResult');
    const errorMessage = document.getElementById('errorMessage');
    const capturedImage = document.getElementById('capturedImage');
    const cameraStatus = document.getElementById('cameraStatus');
    const countdown = document.getElementById('countdown');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const captureText = document.getElementById('captureText');
    const historyCard = document.getElementById('historyCard');
    const moodHistory = document.getElementById('moodHistory');

    let useTimer = false;
    let stream = null;

    // Access the webcam
    async function initializeCamera() {
        cameraStatus.style.display = 'block';
        cameraStatus.textContent = 'Initializing camera...';
        
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: "user"
                } 
            });
            video.srcObject = stream;
            cameraStatus.style.display = 'none';
        } catch (err) {
            console.error("Error accessing webcam: ", err);
            cameraStatus.textContent = "Error accessing webcam. Please make sure it's connected and permissions are granted.";
            cameraStatus.classList.remove('alert-info');
            cameraStatus.classList.add('alert-danger');
        }
    }

    initializeCamera();

    // Timer functionality
    timerButton.addEventListener('click', () => {
        useTimer = !useTimer;
        timerButton.textContent = useTimer ? 'Disable Timer' : 'Use 3s Timer';
        timerButton.classList.toggle('btn-info');
        timerButton.classList.toggle('btn-secondary');
    });

    async function startCountdown() {
        return new Promise((resolve) => {
            let count = 3;
            countdown.style.display = 'block';
            
            const countInterval = setInterval(() => {
                if (count > 0) {
                    countdown.textContent = count;
                    count--;
                } else {
                    clearInterval(countInterval);
                    countdown.style.display = 'none';
                    resolve();
                }
            }, 1000);
        });
    }

    // Add to history
    function addToHistory(mood, backend) {
        const timestamp = new Date().toLocaleTimeString();
        const historyItem = document.createElement('a');
        historyItem.className = 'list-group-item list-group-item-action';
        historyItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${mood}</h6>
                <small>${timestamp}</small>
            </div>
            <small class="text-muted">Using ${backend}</small>
        `;
        moodHistory.prepend(historyItem);
        historyCard.style.display = 'block';
        
        // Keep only last 5 entries
        while (moodHistory.children.length > 5) {
            moodHistory.removeChild(moodHistory.lastChild);
        }
    }

    // Capture the mood and image
    captureButton.addEventListener('click', async () => {
        moodResult.textContent = '';
        errorMessage.textContent = '';
        captureButton.disabled = true;
        
        if (useTimer) {
            await startCountdown();
        }

        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const selectedBackend = document.querySelector('input[name="backend"]:checked').value;

        // Display the captured image
        const dataURL = canvas.toDataURL('image/jpeg');
        capturedImage.src = dataURL;
        capturedImage.style.display = 'block';

        // Show loading state
        loadingSpinner.style.display = 'inline-block';
        captureText.textContent = 'Analyzing...';

        // Send image to the server for mood analysis
        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('image', blob, 'capture.jpg');
            formData.append('backend', selectedBackend);

            fetch('/webcam', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.mood.includes("Error")) {
                    errorMessage.textContent = data.mood;
                    moodResult.textContent = '';
                    document.getElementById('moodResultOverlay').style.display = 'none';
                } else {
                    // Display main emotion and backend
                    document.getElementById('moodResultText').textContent = 
                        `Your mood is: ${data.mood} (using ${selectedBackend})`;
                    
                    // Display confidence score
                    document.getElementById('confidenceScore').textContent = 
                        `Confidence: ${data.confidence}%`;
                    
                    // Display all emotions if available
                    const allEmotionsElem = document.getElementById('allEmotions');
                    if (data.all_emotions && Object.keys(data.all_emotions).length > 0) {
                        const emotionBars = Object.entries(data.all_emotions)
                            .map(([emotion, score]) => {
                                const barWidth = score;
                                return `
                                    <div class="d-flex align-items-center justify-content-between" style="margin: 2px 0;">
                                        <span style="width: 70px; text-align: right; margin-right: 5px;">${emotion}:</span>
                                        <div class="progress" style="height: 4px; flex-grow: 1; margin: 0 5px; background-color: rgba(255,255,255,0.2);">
                                            <div class="progress-bar bg-info" style="width: ${barWidth}%"></div>
                                        </div>
                                        <span style="width: 40px; text-align: left;">${score}%</span>
                                    </div>`;
                            })
                            .join('');
                        allEmotionsElem.innerHTML = emotionBars;
                    } else {
                        allEmotionsElem.innerHTML = '';
                    }
                    
                    document.getElementById('moodResultOverlay').style.display = 'block';
                    moodResult.textContent = '';
                    errorMessage.textContent = '';
                    addToHistory(data.mood, selectedBackend);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                errorMessage.textContent = 'Error analyzing mood. Please try again.';
                moodResult.textContent = '';
            })
            .finally(() => {
                captureButton.disabled = false;
                clearButton.style.display = 'inline-block';
                loadingSpinner.style.display = 'none';
                captureText.textContent = 'Capture Mood';
            });
        }, 'image/jpeg');
    });

    // Clear the captured data
    clearButton.addEventListener('click', () => {
        capturedImage.style.display = 'none';
        capturedImage.src = '';
        moodResult.textContent = '';
        errorMessage.textContent = '';
        clearButton.style.display = 'none';
        document.getElementById('moodResultOverlay').style.display = 'none';
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    });
</script>
{% endblock %}